{
  "meta": {
    "generated_at": "2026-02-04",
    "repo_path": "/mnt/c/Users/orlan/Documentos/GitHub/livestock",
    "sources": {
      "prisma_schema": "packages/db/prisma/schema.prisma",
      "routes_glob": "apps/api/src/routes/**",
      "services_glob": "apps/api/src/services/**",
      "plugins_glob": "apps/api/src/plugins/**",
      "shared_glob": "packages/shared/src/**",
      "importer_spec": "importer_spec.md",
      "import_scripts": [
        "apps/api/src/scripts/import-events.ts",
        "apps/api/src/scripts/import-costs.ts",
        "apps/api/src/scripts/seed.ts"
      ]
    },
    "warnings": [
      "OpenAPI documentation endpoints (/docs, /docs/json, /docs/yaml) are registered by @fastify/swagger-ui when OPENAPI_ENABLED is true, but their response schemas are not defined in local code; response_schema is set to null for those endpoints. Searched apps/api/src/plugins/openapi.ts.",
      "Cost create schema accepts payload but the cost service does not persist payload (no payload column in CostEvent). Searched apps/api/src/routes/costs.ts, packages/shared/src/schemas.ts, apps/api/src/services/costs.ts, packages/db/prisma/schema.prisma.",
      "Export dimensions CSV writes meta via String(value) (no JSON serialization), so objects may appear as [object Object]. Searched apps/api/src/routes/dimensions.ts and apps/api/src/utils/csv.ts."
    ]
  },
  "stack": {
    "language": "TypeScript",
    "runtime": {
      "node": ">=20.0.0"
    },
    "http_framework": {
      "name": "fastify",
      "version": "^4.25.2"
    },
    "database": {
      "engine": "PostgreSQL",
      "version": "15",
      "orm": "Prisma ^5.10.2",
      "datasource_env": "DATABASE_URL"
    },
    "cache_pubsub": {
      "engine": "Redis",
      "version": "7",
      "client": "ioredis ^5.3.2",
      "env": "REDIS_URL"
    },
    "websocket": {
      "library": "@fastify/websocket ^7.0.1",
      "path": "/ws"
    },
    "validation": {
      "library": "zod ^3.22.4"
    },
    "auth": {
      "jwt": "@fastify/jwt ^8.0.1",
      "password_hash": "bcryptjs ^2.4.3"
    },
    "openapi": {
      "enabled_by_default_non_prod": true,
      "plugins": [
        "@fastify/swagger ^8.13.0",
        "@fastify/swagger-ui ^1.0.0"
      ],
      "title": "GANADERIA AVANZADA API",
      "version": "0.1.0",
      "routes": [
        "/docs",
        "/docs/json",
        "/docs/yaml"
      ]
    },
    "rate_limit": {
      "plugin": "@fastify/rate-limit ^8.0.0",
      "default": {
        "max": 200,
        "timeWindow": "1 minute"
      }
    },
    "cors": {
      "plugin": "@fastify/cors ^9.0.1",
      "origin_default": "*"
    },
    "logging": {
      "logger": "pino ^8.17.1",
      "request_id_header": "x-request-id"
    },
    "serialization": {
      "bigint": "string (preSerialization converts BigInt to string)",
      "decimal": "string (Prisma Decimal serializes to string)"
    }
  },
  "auth": {
    "scheme": "bearer",
    "access_token": {
      "header": "Authorization: Bearer <accessToken>",
      "jwt_claims": [
        "id",
        "role",
        "email"
      ],
      "expires_in": "JWT_ACCESS_EXPIRES (default 15m)",
      "signing_secret_env": "JWT_ACCESS_SECRET"
    },
    "refresh_token": {
      "delivery": "JSON body field refreshToken",
      "jwt_claims": [
        "id",
        "role",
        "email",
        "jti"
      ],
      "expires_in": "JWT_REFRESH_EXPIRES (default 7d)",
      "signing_secret_env": "JWT_REFRESH_SECRET",
      "storage": {
        "table": "RefreshToken",
        "token_hash": "sha256(refreshToken) stored in RefreshToken.token",
        "legacy_fallback": "bcrypt hash comparison supported if RefreshToken.token begins with $2"
      }
    },
    "rotation": {
      "refresh_endpoint": "/auth/refresh",
      "behavior": [
        "Verify refresh token signature with JWT_REFRESH_SECRET",
        "Find matching refresh token by sha256 hash or legacy bcrypt hash",
        "Reject if missing, revoked, or expired",
        "Revoke all matching tokens, issue new access+refresh tokens",
        "Revoke any other non-revoked tokens for the user"
      ]
    },
    "bootstrap_admin": {
      "allowed_when": "No users exist OR BOOTSTRAP_ADMIN=true",
      "enforced_in": [
        "apps/api/src/routes/auth.ts",
        "apps/api/src/services/auth.ts"
      ]
    }
  },
  "roles_acl": {
    "roles": [
      "viewer",
      "manager",
      "admin"
    ],
    "hierarchy": {
      "viewer": 0,
      "manager": 1,
      "admin": 2
    },
    "allows_rule": "roleAllows(role, required) returns true when role index >= required index"
  },
  "rest_api": {
    "base_path": "/",
    "common_headers": {
      "x-request-id": "Optional; if provided, echoed in response and used in logs and WS messages",
      "Authorization": "Bearer <accessToken> required on protected routes"
    },
    "endpoints": [
      {
        "method": "GET",
        "path": "/healthz",
        "required_role": null,
        "headers": {
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": null
        },
        "response_schema": {
          "200": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "status"
            ],
            "properties": {
              "status": {
                "type": "string"
              }
            }
          }
        },
        "error_shapes": [
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "None"
        ]
      },
      {
        "method": "GET",
        "path": "/readyz",
        "required_role": null,
        "headers": {
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": null
        },
        "response_schema": {
          "200": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "status"
            ],
            "properties": {
              "status": {
                "type": "string"
              }
            }
          },
          "500": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "status",
              "err"
            ],
            "properties": {
              "status": {
                "type": "string"
              },
              "err": {
                "type": "string"
              }
            }
          }
        },
        "error_shapes": [
          {
            "status": 500,
            "body": {
              "status": "not_ready",
              "err": "<string>"
            }
          }
        ],
        "side_effects": [
          "Runs DB and Redis health checks"
        ]
      },
      {
        "method": "GET",
        "path": "/metrics",
        "required_role": null,
        "headers": {
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": null
        },
        "response_schema": {
          "200": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "uptime_sec",
              "rss",
              "heapUsed",
              "heapTotal",
              "pid",
              "node_version",
              "db_ok",
              "redis_ok"
            ],
            "properties": {
              "uptime_sec": {
                "type": "number"
              },
              "rss": {
                "type": "number"
              },
              "heapUsed": {
                "type": "number"
              },
              "heapTotal": {
                "type": "number"
              },
              "pid": {
                "type": "number"
              },
              "node_version": {
                "type": "string"
              },
              "db_ok": {
                "type": "boolean"
              },
              "redis_ok": {
                "type": "boolean"
              },
              "timestamp": {
                "type": "string"
              }
            }
          }
        },
        "error_shapes": [
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Runs DB and Redis health checks"
        ]
      },
      {
        "method": "GET",
        "path": "/info",
        "required_role": null,
        "headers": {
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": null
        },
        "response_schema": {
          "200": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "name",
              "version",
              "env"
            ],
            "properties": {
              "name": {
                "type": "string"
              },
              "version": {
                "type": "string"
              },
              "env": {
                "type": "string"
              }
            }
          }
        },
        "error_shapes": [
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "None"
        ]
      },
      {
        "method": "POST",
        "path": "/auth/register",
        "required_role": "admin (unless bootstrap allowed)",
        "headers": {
          "Authorization": "Bearer <accessToken> required unless bootstrap allowed",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": {
            "type": "object",
            "required": [
              "email",
              "password",
              "role"
            ],
            "additionalProperties": true,
            "properties": {
              "email": {
                "type": "string",
                "format": "email"
              },
              "password": {
                "type": "string",
                "minLength": 8
              },
              "role": {
                "type": "string",
                "enum": [
                  "admin",
                  "manager",
                  "viewer"
                ]
              }
            }
          }
        },
        "response_schema": {
          "201": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "id",
              "email",
              "role"
            ],
            "properties": {
              "id": {
                "type": "number"
              },
              "email": {
                "type": "string"
              },
              "role": {
                "type": "string"
              }
            }
          }
        },
        "error_shapes": [
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 409,
            "body": {
              "message": "User already exists"
            }
          },
          {
            "status": 400,
            "body": {
              "message": "Validation error",
              "details": "Zod issues array"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Creates user and bcrypt password hash"
        ]
      },
      {
        "method": "POST",
        "path": "/auth/login",
        "required_role": null,
        "headers": {
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": {
            "type": "object",
            "required": [
              "email",
              "password"
            ],
            "additionalProperties": true,
            "properties": {
              "email": {
                "type": "string",
                "format": "email"
              },
              "password": {
                "type": "string",
                "minLength": 1
              }
            }
          }
        },
        "response_schema": {
          "200": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "accessToken",
              "refreshToken",
              "user",
              "expires_at"
            ],
            "properties": {
              "accessToken": {
                "type": "string"
              },
              "refreshToken": {
                "type": "string"
              },
              "expires_at": {
                "type": "string",
                "format": "date-time"
              },
              "user": {
                "type": "object",
                "additionalProperties": false,
                "required": [
                  "id",
                  "email",
                  "role"
                ],
                "properties": {
                  "id": {
                    "type": "number"
                  },
                  "email": {
                    "type": "string"
                  },
                  "role": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "error_shapes": [
          {
            "status": 401,
            "body": {
              "message": "Invalid credentials"
            }
          },
          {
            "status": 400,
            "body": {
              "message": "Validation error",
              "details": "Zod issues array"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Deletes revoked/expired refresh tokens for user",
          "Issues new access+refresh tokens"
        ]
      },
      {
        "method": "POST",
        "path": "/auth/refresh",
        "required_role": null,
        "headers": {
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": {
            "type": "object",
            "required": [
              "refreshToken"
            ],
            "additionalProperties": true,
            "properties": {
              "refreshToken": {
                "type": "string"
              }
            }
          }
        },
        "response_schema": {
          "200": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "accessToken",
              "refreshToken",
              "user"
            ],
            "properties": {
              "accessToken": {
                "type": "string"
              },
              "refreshToken": {
                "type": "string"
              },
              "user": {
                "type": "object",
                "additionalProperties": false,
                "required": [
                  "id",
                  "email",
                  "role"
                ],
                "properties": {
                  "id": {
                    "type": "number"
                  },
                  "email": {
                    "type": "string"
                  },
                  "role": {
                    "type": "string"
                  }
                }
              }
            }
          }
        },
        "error_shapes": [
          {
            "status": 400,
            "body": {
              "message": "refreshToken required"
            }
          },
          {
            "status": 401,
            "body": {
              "message": "Invalid refresh token"
            }
          },
          {
            "status": 401,
            "body": {
              "message": "User not found"
            }
          },
          {
            "status": 401,
            "body": {
              "message": "Refresh token revoked or missing"
            }
          },
          {
            "status": 401,
            "body": {
              "message": "Refresh token expired"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Revokes matching refresh tokens and rotates to new tokens"
        ]
      },
      {
        "method": "GET",
        "path": "/animals",
        "required_role": "viewer",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": {
            "type": "object",
            "additionalProperties": true,
            "properties": {
              "limit": {
                "type": "integer",
                "minimum": 1,
                "maximum": 5000
              },
              "cursor": {
                "type": "string"
              },
              "search": {
                "type": "string"
              },
              "min_age_months": {
                "type": "integer"
              },
              "max_age_months": {
                "type": "integer"
              },
              "min_weight": {
                "type": "number"
              },
              "max_weight": {
                "type": "number"
              },
              "brand_mark": {
                "type": "string"
              },
              "last_event_type": {
                "type": "string"
              },
              "location_code": {
                "type": "string"
              },
              "from": {
                "type": "string"
              },
              "to": {
                "type": "string"
              }
            }
          },
          "body": null
        },
        "response_schema": {
          "200": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "data": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": true
                }
              },
              "nextCursor": {
                "type": [
                  "string",
                  "null"
                ]
              }
            }
          }
        },
        "error_shapes": [
          {
            "status": 400,
            "body": {
              "message": "Validation error",
              "details": "Zod issues array"
            }
          },
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Reads Animal table",
          "May run raw SQL to filter by latest weight"
        ]
      },
      {
        "method": "GET",
        "path": "/animals/:uid",
        "required_role": "viewer",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": {
            "type": "object",
            "required": [
              "uid"
            ],
            "properties": {
              "uid": {
                "type": "string"
              }
            }
          },
          "query": null,
          "body": null
        },
        "response_schema": {
          "200": {
            "type": "object",
            "additionalProperties": true
          }
        },
        "error_shapes": [
          {
            "status": 404,
            "body": {
              "message": "Animal not found"
            }
          },
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Reads Animal table"
        ]
      },
      {
        "method": "POST",
        "path": "/animals",
        "required_role": "admin",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": {
            "type": "object",
            "required": [
              "uid"
            ],
            "additionalProperties": true,
            "properties": {
              "uid": {
                "type": "string"
              },
              "eid": {
                "type": "string"
              },
              "vid": {
                "type": "string"
              },
              "registration_at": {
                "type": "string"
              },
              "alert": {
                "type": "boolean"
              },
              "race": {
                "type": "string"
              },
              "sex": {
                "type": "string"
              },
              "color": {
                "type": "string"
              },
              "mother_name": {
                "type": "string"
              },
              "father_name": {
                "type": "string"
              },
              "brand_mark": {
                "type": "string"
              },
              "birth_year": {
                "type": "number"
              },
              "birth_month": {
                "type": "number"
              },
              "birth_place": {
                "type": "string"
              },
              "diagnostic": {
                "type": "string"
              },
              "warning": {
                "type": "string"
              },
              "notes": {
                "type": "string"
              }
            }
          }
        },
        "response_schema": {
          "201": {
            "type": "object",
            "additionalProperties": true
          }
        },
        "error_shapes": [
          {
            "status": 400,
            "body": {
              "message": "Validation error",
              "details": "Zod issues array"
            }
          },
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Creates Animal row",
          "Publishes WS topic animal.updated with {uid}"
        ]
      },
      {
        "method": "PATCH",
        "path": "/animals/:uid",
        "required_role": "manager",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "if-match-version": "required numeric string",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": {
            "type": "object",
            "required": [
              "uid"
            ],
            "properties": {
              "uid": {
                "type": "string"
              }
            }
          },
          "query": null,
          "body": {
            "type": "object",
            "additionalProperties": true,
            "properties": {
              "eid": {
                "type": "string"
              },
              "vid": {
                "type": "string"
              },
              "registration_at": {
                "type": "string"
              },
              "alert": {
                "type": "boolean"
              },
              "race": {
                "type": "string"
              },
              "sex": {
                "type": "string"
              },
              "color": {
                "type": "string"
              },
              "mother_name": {
                "type": "string"
              },
              "father_name": {
                "type": "string"
              },
              "brand_mark": {
                "type": "string"
              },
              "birth_year": {
                "type": "number"
              },
              "birth_month": {
                "type": "number"
              },
              "birth_place": {
                "type": "string"
              },
              "diagnostic": {
                "type": "string"
              },
              "warning": {
                "type": "string"
              },
              "notes": {
                "type": "string"
              }
            }
          }
        },
        "response_schema": {
          "200": {
            "type": "object",
            "additionalProperties": true
          }
        },
        "error_shapes": [
          {
            "status": 400,
            "body": {
              "message": "If-Match-Version header required"
            }
          },
          {
            "status": 400,
            "body": {
              "message": "Invalid version header"
            }
          },
          {
            "status": 404,
            "body": {
              "message": "Animal not found"
            }
          },
          {
            "status": 409,
            "body": {
              "message": "Version mismatch",
              "details": {
                "currentVersion": "number"
              }
            }
          },
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Updates Animal row",
          "Increments Animal.version",
          "Publishes WS topic animal.updated with {uid, version}"
        ]
      },
      {
        "method": "GET",
        "path": "/animals/:uid/events",
        "required_role": "viewer",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": {
            "type": "object",
            "required": [
              "uid"
            ],
            "properties": {
              "uid": {
                "type": "string"
              }
            }
          },
          "query": {
            "type": "object",
            "additionalProperties": true,
            "properties": {
              "limit": {
                "type": "integer",
                "minimum": 1,
                "maximum": 5000
              },
              "cursor": {
                "type": "string"
              }
            }
          },
          "body": null
        },
        "response_schema": {
          "200": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "data": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": true
                }
              },
              "nextCursor": {
                "type": [
                  "string",
                  "null"
                ]
              }
            }
          }
        },
        "error_shapes": [
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Reads AnimalEvent and subtype tables"
        ]
      },
      {
        "method": "GET",
        "path": "/export/animals",
        "required_role": "viewer",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": {
            "type": "object",
            "additionalProperties": true,
            "properties": {
              "format": {
                "type": "string",
                "enum": [
                  "json",
                  "csv"
                ]
              },
              "limit": {
                "type": "integer",
                "minimum": 1,
                "maximum": 5000
              },
              "cursor": {
                "type": "string"
              },
              "search": {
                "type": "string"
              },
              "brand_mark": {
                "type": "string"
              },
              "alert": {
                "type": "boolean"
              },
              "min_age_months": {
                "type": "integer"
              },
              "max_age_months": {
                "type": "integer"
              },
              "min_weight": {
                "type": "number"
              },
              "max_weight": {
                "type": "number"
              },
              "last_event_type": {
                "type": "string"
              }
            }
          },
          "body": null
        },
        "response_schema": {
          "200": {
            "description": "JSON response when format=json; CSV when format=csv",
            "type": "object",
            "properties": {
              "data": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": true
                }
              },
              "nextCursor": {
                "type": [
                  "string",
                  "null"
                ]
              }
            }
          }
        },
        "error_shapes": [
          {
            "status": 400,
            "body": {
              "message": "Invalid limit"
            }
          },
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Reads Animal table",
          "May return CSV with x-next-cursor header"
        ]
      },
      {
        "method": "POST",
        "path": "/events",
        "required_role": "manager",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "idempotency-key": "optional; overrides source_ref for dedupe",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": {
            "type": "object",
            "additionalProperties": true,
            "required": [
              "uid",
              "event_at",
              "event_type"
            ],
            "properties": {
              "uid": {
                "type": "string"
              },
              "event_at": {
                "type": "string"
              },
              "event_type": {
                "type": "string",
                "enum": [
                  "weight",
                  "movement",
                  "repro",
                  "health",
                  "nutrition",
                  "inventory",
                  "management",
                  "diagnostic",
                  "environment"
                ]
              },
              "event_subtype": {
                "type": "string"
              },
              "source_ref": {
                "type": "string"
              },
              "batch_id": {
                "type": "string"
              },
              "confidence": {
                "type": "number"
              },
              "notes": {
                "type": "string"
              },
              "payload": {
                "type": "object",
                "additionalProperties": true
              },
              "location_from_code": {
                "type": "string"
              },
              "location_to_code": {
                "type": "string"
              },
              "group_code": {
                "type": "string"
              },
              "party_code": {
                "type": "string"
              },
              "product_code": {
                "type": "string"
              },
              "weight_kg": {
                "type": "number"
              },
              "method": {
                "type": "string"
              },
              "shrink_pct": {
                "type": "number"
              },
              "reason": {
                "type": "string"
              },
              "distance_km": {
                "type": "number"
              },
              "transport_party_code": {
                "type": "string"
              },
              "repro_action": {
                "type": "string"
              },
              "sire_uid": {
                "type": "string"
              },
              "dam_uid": {
                "type": "string"
              },
              "result": {
                "type": "string"
              },
              "calf_uid": {
                "type": "string"
              },
              "gestation_days": {
                "type": "number"
              },
              "action": {
                "type": "string"
              },
              "diagnosis": {
                "type": "string"
              },
              "dose": {
                "type": "number"
              },
              "dose_unit": {
                "type": "string"
              },
              "withdrawal_days": {
                "type": "number"
              },
              "ration_code": {
                "type": "string"
              },
              "intake_kg_day": {
                "type": "number"
              },
              "supplement_code": {
                "type": "string"
              }
            }
          }
        },
        "response_schema": {
          "200": {
            "type": "object",
            "additionalProperties": true
          },
          "201": {
            "type": "object",
            "additionalProperties": true
          }
        },
        "error_shapes": [
          {
            "status": 400,
            "body": {
              "message": "Movement events require location_from_code and location_to_code"
            }
          },
          {
            "status": 400,
            "body": {
              "message": "Validation error",
              "details": "Zod issues array"
            }
          },
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Creates Animal if missing",
          "Resolves/auto-creates dimensions (location, herdGroup, party, product)",
          "Creates AnimalEvent + subtype table row when applicable",
          "Publishes WS topic event.created"
        ]
      },
      {
        "method": "POST",
        "path": "/events/bulk",
        "required_role": "manager",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "idempotency-key": "optional; overrides source_ref for each event if set",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": {
            "type": "object",
            "additionalProperties": true,
            "required": [
              "events"
            ],
            "properties": {
              "events": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": true,
                  "required": [
                    "uid",
                    "event_at",
                    "event_type"
                  ],
                  "properties": {
                    "uid": {
                      "type": "string"
                    },
                    "event_at": {
                      "type": "string"
                    },
                    "event_type": {
                      "type": "string",
                      "enum": [
                        "weight",
                        "movement",
                        "repro",
                        "health",
                        "nutrition",
                        "inventory",
                        "management",
                        "diagnostic",
                        "environment"
                      ]
                    },
                    "event_subtype": {
                      "type": "string"
                    },
                    "source_ref": {
                      "type": "string"
                    },
                    "batch_id": {
                      "type": "string"
                    },
                    "confidence": {
                      "type": "number"
                    },
                    "notes": {
                      "type": "string"
                    },
                    "payload": {
                      "type": "object",
                      "additionalProperties": true
                    },
                    "location_from_code": {
                      "type": "string"
                    },
                    "location_to_code": {
                      "type": "string"
                    },
                    "group_code": {
                      "type": "string"
                    },
                    "party_code": {
                      "type": "string"
                    },
                    "product_code": {
                      "type": "string"
                    },
                    "weight_kg": {
                      "type": "number"
                    },
                    "method": {
                      "type": "string"
                    },
                    "shrink_pct": {
                      "type": "number"
                    },
                    "reason": {
                      "type": "string"
                    },
                    "distance_km": {
                      "type": "number"
                    },
                    "transport_party_code": {
                      "type": "string"
                    },
                    "repro_action": {
                      "type": "string"
                    },
                    "sire_uid": {
                      "type": "string"
                    },
                    "dam_uid": {
                      "type": "string"
                    },
                    "result": {
                      "type": "string"
                    },
                    "calf_uid": {
                      "type": "string"
                    },
                    "gestation_days": {
                      "type": "number"
                    },
                    "action": {
                      "type": "string"
                    },
                    "diagnosis": {
                      "type": "string"
                    },
                    "dose": {
                      "type": "number"
                    },
                    "dose_unit": {
                      "type": "string"
                    },
                    "withdrawal_days": {
                      "type": "number"
                    },
                    "ration_code": {
                      "type": "string"
                    },
                    "intake_kg_day": {
                      "type": "number"
                    },
                    "supplement_code": {
                      "type": "string"
                    }
                  }
                }
              }
            }
          }
        },
        "response_schema": {
          "200": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "events": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": true
                }
              }
            }
          },
          "201": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "events": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": true
                }
              }
            }
          }
        },
        "error_shapes": [
          {
            "status": 400,
            "body": {
              "message": "Validation error",
              "details": "Zod issues array"
            }
          },
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Creates Animal if missing for each event",
          "Resolves/auto-creates dimensions (location, herdGroup, party, product)",
          "Creates AnimalEvent + subtype rows in a DB transaction",
          "Publishes WS topic event.created for each event"
        ]
      },
      {
        "method": "GET",
        "path": "/events",
        "required_role": "viewer",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": {
            "type": "object",
            "additionalProperties": true,
            "properties": {
              "limit": {
                "type": "integer",
                "minimum": 1,
                "maximum": 5000
              },
              "cursor": {
                "type": "string"
              },
              "uid": {
                "type": "string"
              },
              "event_type": {
                "type": "string"
              },
              "from": {
                "type": "string"
              },
              "to": {
                "type": "string"
              },
              "location_code": {
                "type": "string"
              },
              "group_code": {
                "type": "string"
              },
              "batch_id": {
                "type": "string"
              }
            }
          },
          "body": null
        },
        "response_schema": {
          "200": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "data": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": true
                }
              },
              "nextCursor": {
                "type": [
                  "string",
                  "null"
                ]
              }
            }
          }
        },
        "error_shapes": [
          {
            "status": 400,
            "body": {
              "message": "Validation error",
              "details": "Zod issues array"
            }
          },
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Reads AnimalEvent and subtype tables"
        ]
      },
      {
        "method": "GET",
        "path": "/export/events",
        "required_role": "viewer",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": {
            "type": "object",
            "additionalProperties": true,
            "properties": {
              "format": {
                "type": "string",
                "enum": [
                  "json",
                  "csv"
                ]
              },
              "include_payload": {
                "type": "boolean"
              },
              "limit": {
                "type": "integer",
                "minimum": 1,
                "maximum": 5000
              },
              "cursor": {
                "type": "string"
              },
              "uid": {
                "type": "string"
              },
              "event_type": {
                "type": "string"
              },
              "from": {
                "type": "string"
              },
              "to": {
                "type": "string"
              },
              "location_code": {
                "type": "string"
              },
              "group_code": {
                "type": "string"
              },
              "batch_id": {
                "type": "string"
              }
            }
          },
          "body": null
        },
        "response_schema": {
          "200": {
            "description": "JSON response when format=json; CSV when format=csv",
            "type": "object",
            "properties": {
              "data": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": true
                }
              },
              "nextCursor": {
                "type": [
                  "string",
                  "null"
                ]
              }
            }
          }
        },
        "error_shapes": [
          {
            "status": 400,
            "body": {
              "message": "Invalid limit"
            }
          },
          {
            "status": 400,
            "body": {
              "message": "Invalid cursor"
            }
          },
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Reads AnimalEvent and subtype tables",
          "May return CSV with x-next-cursor header"
        ]
      },
      {
        "method": "POST",
        "path": "/costs",
        "required_role": "manager",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": {
            "type": "object",
            "additionalProperties": true,
            "required": [
              "cost_at",
              "scope",
              "category",
              "amount"
            ],
            "properties": {
              "cost_at": {
                "type": "string"
              },
              "scope": {
                "type": "string",
                "enum": [
                  "animal",
                  "group",
                  "location",
                  "ranch",
                  "batch"
                ]
              },
              "uid": {
                "type": "string"
              },
              "group_code": {
                "type": "string"
              },
              "location_code": {
                "type": "string"
              },
              "category": {
                "type": "string",
                "enum": [
                  "feed",
                  "health",
                  "labor",
                  "transport",
                  "capex",
                  "misc"
                ]
              },
              "product_code": {
                "type": "string"
              },
              "party_code": {
                "type": "string"
              },
              "amount": {
                "type": "number"
              },
              "currency": {
                "type": "string"
              },
              "quantity": {
                "type": "number"
              },
              "unit": {
                "type": "string"
              },
              "source_ref": {
                "type": "string"
              },
              "batch_id": {
                "type": "string"
              },
              "notes": {
                "type": "string"
              },
              "payload": {
                "type": "object",
                "additionalProperties": true
              }
            }
          }
        },
        "response_schema": {
          "201": {
            "type": "object",
            "additionalProperties": true
          }
        },
        "error_shapes": [
          {
            "status": 400,
            "body": {
              "message": "Validation error",
              "details": "Zod issues array"
            }
          },
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Resolves/auto-creates dimensions (location, herdGroup, party, product)",
          "Creates CostEvent",
          "Publishes WS topic cost.created"
        ]
      },
      {
        "method": "POST",
        "path": "/costs/bulk",
        "required_role": "manager",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": {
            "type": "object",
            "additionalProperties": true,
            "required": [
              "costs"
            ],
            "properties": {
              "costs": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": true,
                  "required": [
                    "cost_at",
                    "scope",
                    "category",
                    "amount"
                  ],
                  "properties": {
                    "cost_at": {
                      "type": "string"
                    },
                    "scope": {
                      "type": "string",
                      "enum": [
                        "animal",
                        "group",
                        "location",
                        "ranch",
                        "batch"
                      ]
                    },
                    "uid": {
                      "type": "string"
                    },
                    "group_code": {
                      "type": "string"
                    },
                    "location_code": {
                      "type": "string"
                    },
                    "category": {
                      "type": "string",
                      "enum": [
                        "feed",
                        "health",
                        "labor",
                        "transport",
                        "capex",
                        "misc"
                      ]
                    },
                    "product_code": {
                      "type": "string"
                    },
                    "party_code": {
                      "type": "string"
                    },
                    "amount": {
                      "type": "number"
                    },
                    "currency": {
                      "type": "string"
                    },
                    "quantity": {
                      "type": "number"
                    },
                    "unit": {
                      "type": "string"
                    },
                    "source_ref": {
                      "type": "string"
                    },
                    "batch_id": {
                      "type": "string"
                    },
                    "notes": {
                      "type": "string"
                    },
                    "payload": {
                      "type": "object",
                      "additionalProperties": true
                    }
                  }
                }
              }
            }
          }
        },
        "response_schema": {
          "201": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "costs": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": true
                }
              }
            }
          }
        },
        "error_shapes": [
          {
            "status": 400,
            "body": {
              "message": "Validation error",
              "details": "Zod issues array"
            }
          },
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Creates CostEvent rows in a DB transaction",
          "Resolves/auto-creates dimensions (location, herdGroup, party, product)",
          "Publishes WS topic cost.created for each cost"
        ]
      },
      {
        "method": "GET",
        "path": "/costs",
        "required_role": "viewer",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": {
            "type": "object",
            "additionalProperties": true,
            "properties": {
              "limit": {
                "type": "integer",
                "minimum": 1,
                "maximum": 5000
              },
              "cursor": {
                "type": "string"
              },
              "scope": {
                "type": "string"
              },
              "uid": {
                "type": "string"
              },
              "category": {
                "type": "string"
              },
              "batch_id": {
                "type": "string"
              },
              "from": {
                "type": "string"
              },
              "to": {
                "type": "string"
              }
            }
          },
          "body": null
        },
        "response_schema": {
          "200": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "data": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": true
                }
              },
              "nextCursor": {
                "type": [
                  "string",
                  "null"
                ]
              }
            }
          }
        },
        "error_shapes": [
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Reads CostEvent table"
        ]
      },
      {
        "method": "GET",
        "path": "/export/costs",
        "required_role": "viewer",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": {
            "type": "object",
            "additionalProperties": true,
            "properties": {
              "format": {
                "type": "string",
                "enum": [
                  "json",
                  "csv"
                ]
              },
              "limit": {
                "type": "integer",
                "minimum": 1,
                "maximum": 5000
              },
              "cursor": {
                "type": "string"
              },
              "scope": {
                "type": "string"
              },
              "uid": {
                "type": "string"
              },
              "category": {
                "type": "string"
              },
              "batch_id": {
                "type": "string"
              },
              "from": {
                "type": "string"
              },
              "to": {
                "type": "string"
              }
            }
          },
          "body": null
        },
        "response_schema": {
          "200": {
            "description": "JSON response when format=json; CSV when format=csv",
            "type": "object",
            "properties": {
              "data": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": true
                }
              },
              "nextCursor": {
                "type": [
                  "string",
                  "null"
                ]
              }
            }
          }
        },
        "error_shapes": [
          {
            "status": 400,
            "body": {
              "message": "Invalid limit"
            }
          },
          {
            "status": 400,
            "body": {
              "message": "Invalid cursor"
            }
          },
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Reads CostEvent table",
          "May return CSV with x-next-cursor header"
        ]
      },
      {
        "method": "GET",
        "path": "/locations",
        "required_role": "viewer",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": null
        },
        "response_schema": {
          "200": {
            "type": "array",
            "items": {
              "type": "object",
              "additionalProperties": true
            }
          }
        },
        "error_shapes": [
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Reads Location table"
        ]
      },
      {
        "method": "POST",
        "path": "/locations",
        "required_role": "admin",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": {
            "type": "object",
            "additionalProperties": true,
            "required": [
              "code"
            ],
            "properties": {
              "code": {
                "type": "string"
              },
              "name": {
                "type": "string"
              },
              "type": {
                "type": "string"
              },
              "meta": {
                "type": "object",
                "additionalProperties": true
              }
            }
          }
        },
        "response_schema": {
          "201": {
            "type": "object",
            "additionalProperties": true
          }
        },
        "error_shapes": [
          {
            "status": 400,
            "body": {
              "message": "Validation error",
              "details": "Zod issues array"
            }
          },
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Creates Location row",
          "Publishes WS topic dimension.updated with {table, code}"
        ]
      },
      {
        "method": "GET",
        "path": "/groups",
        "required_role": "viewer",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": null
        },
        "response_schema": {
          "200": {
            "type": "array",
            "items": {
              "type": "object",
              "additionalProperties": true
            }
          }
        },
        "error_shapes": [
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Reads HerdGroup table"
        ]
      },
      {
        "method": "POST",
        "path": "/groups",
        "required_role": "admin",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": {
            "type": "object",
            "additionalProperties": true,
            "required": [
              "code"
            ],
            "properties": {
              "code": {
                "type": "string"
              },
              "name": {
                "type": "string"
              },
              "meta": {
                "type": "object",
                "additionalProperties": true
              }
            }
          }
        },
        "response_schema": {
          "201": {
            "type": "object",
            "additionalProperties": true
          }
        },
        "error_shapes": [
          {
            "status": 400,
            "body": {
              "message": "Validation error",
              "details": "Zod issues array"
            }
          },
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Creates HerdGroup row",
          "Publishes WS topic dimension.updated with {table, code}"
        ]
      },
      {
        "method": "GET",
        "path": "/parties",
        "required_role": "viewer",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": null
        },
        "response_schema": {
          "200": {
            "type": "array",
            "items": {
              "type": "object",
              "additionalProperties": true
            }
          }
        },
        "error_shapes": [
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Reads Party table"
        ]
      },
      {
        "method": "POST",
        "path": "/parties",
        "required_role": "admin",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": {
            "type": "object",
            "additionalProperties": true,
            "required": [
              "code"
            ],
            "properties": {
              "code": {
                "type": "string"
              },
              "name": {
                "type": "string"
              },
              "type": {
                "type": "string"
              },
              "meta": {
                "type": "object",
                "additionalProperties": true
              }
            }
          }
        },
        "response_schema": {
          "201": {
            "type": "object",
            "additionalProperties": true
          }
        },
        "error_shapes": [
          {
            "status": 400,
            "body": {
              "message": "Validation error",
              "details": "Zod issues array"
            }
          },
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Creates Party row",
          "Publishes WS topic dimension.updated with {table, code}"
        ]
      },
      {
        "method": "GET",
        "path": "/products",
        "required_role": "viewer",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": null
        },
        "response_schema": {
          "200": {
            "type": "array",
            "items": {
              "type": "object",
              "additionalProperties": true
            }
          }
        },
        "error_shapes": [
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Reads Product table"
        ]
      },
      {
        "method": "POST",
        "path": "/products",
        "required_role": "admin",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": {
            "type": "object",
            "additionalProperties": true,
            "required": [
              "code"
            ],
            "properties": {
              "code": {
                "type": "string"
              },
              "name": {
                "type": "string"
              },
              "category": {
                "type": "string"
              },
              "unit": {
                "type": "string"
              },
              "meta": {
                "type": "object",
                "additionalProperties": true
              }
            }
          }
        },
        "response_schema": {
          "201": {
            "type": "object",
            "additionalProperties": true
          }
        },
        "error_shapes": [
          {
            "status": 400,
            "body": {
              "message": "Validation error",
              "details": "Zod issues array"
            }
          },
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Creates Product row",
          "Publishes WS topic dimension.updated with {table, code}"
        ]
      },
      {
        "method": "GET",
        "path": "/export/dimensions",
        "required_role": "viewer",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": {
            "type": "object",
            "additionalProperties": true,
            "properties": {
              "format": {
                "type": "string",
                "enum": [
                  "json",
                  "csv"
                ]
              },
              "table": {
                "type": "string",
                "enum": [
                  "location",
                  "herdGroup",
                  "party",
                  "product"
                ]
              }
            }
          },
          "body": null
        },
        "response_schema": {
          "200": {
            "description": "JSON response when format=json; CSV when format=csv",
            "type": "object",
            "properties": {
              "data": {
                "type": "array",
                "items": {
                  "type": "object",
                  "additionalProperties": true
                }
              }
            }
          }
        },
        "error_shapes": [
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Reads dimension tables",
          "May return CSV"
        ]
      },
      {
        "method": "GET",
        "path": "/dashboards/summary",
        "required_role": "viewer",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": null
        },
        "response_schema": {
          "200": {
            "type": "object",
            "additionalProperties": true
          }
        },
        "error_shapes": [
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Reads Redis key metrics:summary (TTL 300s)",
          "If missing, recomputes derived metrics and writes to DB and Redis"
        ]
      },
      {
        "method": "GET",
        "path": "/animals/:uid/metrics",
        "required_role": "viewer",
        "headers": {
          "Authorization": "Bearer <accessToken>",
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": {
            "type": "object",
            "required": [
              "uid"
            ],
            "properties": {
              "uid": {
                "type": "string"
              }
            }
          },
          "query": null,
          "body": null
        },
        "response_schema": {
          "200": {
            "type": "object",
            "additionalProperties": true
          }
        },
        "error_shapes": [
          {
            "status": 404,
            "body": {
              "message": "Metrics not found"
            }
          },
          {
            "status": 401,
            "body": {
              "message": "Unauthorized"
            }
          },
          {
            "status": 403,
            "body": {
              "message": "Forbidden"
            }
          },
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Reads DerivedMetric table"
        ]
      },
      {
        "method": "GET",
        "path": "/docs",
        "required_role": null,
        "headers": {
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": null
        },
        "response_schema": null,
        "error_shapes": [
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Serves OpenAPI UI when OPENAPI_ENABLED=true"
        ]
      },
      {
        "method": "GET",
        "path": "/docs/json",
        "required_role": null,
        "headers": {
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": null
        },
        "response_schema": null,
        "error_shapes": [
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Serves OpenAPI JSON when OPENAPI_ENABLED=true"
        ]
      },
      {
        "method": "GET",
        "path": "/docs/yaml",
        "required_role": null,
        "headers": {
          "x-request-id": "optional"
        },
        "request_schema": {
          "params": null,
          "query": null,
          "body": null
        },
        "response_schema": null,
        "error_shapes": [
          {
            "status": 500,
            "body": {
              "message": "Internal Server Error"
            }
          }
        ],
        "side_effects": [
          "Serves OpenAPI YAML when OPENAPI_ENABLED=true"
        ]
      }
    ]
  },
  "websocket": {
    "path": "/ws",
    "auth": {
      "type": "JWT access token",
      "accepted_locations": [
        "Authorization: Bearer <accessToken>",
        "query param token=<accessToken>",
        "query param accessToken=<accessToken>"
      ],
      "verify": "fastify.jwt.verify(accessToken) using JWT_ACCESS_SECRET"
    },
    "message_envelope": {
      "topic": "animal.updated | event.created | cost.created | dimension.updated",
      "ts": "ISO-8601 string",
      "requestId": "string (optional)",
      "data": "any"
    },
    "topics": {
      "animal.updated": {
        "description": "Published on create/update animal",
        "data_schema": {
          "uid": "string",
          "version": "number (only sent on PATCH)"
        }
      },
      "event.created": {
        "description": "Published on event create/bulk/import",
        "data_schema": "AnimalEvent row with subtype relations (weight/movement/repro/health/nutrition)"
      },
      "cost.created": {
        "description": "Published on cost create/bulk/import",
        "data_schema": "CostEvent row"
      },
      "dimension.updated": {
        "description": "Published on dimension create",
        "data_schema": {
          "table": "location | herdGroup | party | product",
          "code": "string"
        }
      }
    },
    "examples": [
      {
        "topic": "animal.updated",
        "ts": "2026-02-04T12:00:00.000Z",
        "requestId": "req-123",
        "data": {
          "uid": "A-001",
          "version": 2
        }
      },
      {
        "topic": "event.created",
        "ts": "2026-02-04T12:01:00.000Z",
        "requestId": "req-124",
        "data": {
          "event_id": "101",
          "uid": "A-001",
          "event_at": "2026-02-04T11:59:00.000Z",
          "event_type": "weight",
          "event_subtype": null,
          "source_ref": "import-001",
          "batch_id": null,
          "confidence": "0.98",
          "notes": null,
          "location_from_id": null,
          "location_to_id": null,
          "group_id": null,
          "party_id": null,
          "product_id": null,
          "payload": {
            "weight_kg": 420,
            "method": "scale",
            "shrink_pct": 0.5
          },
          "created_at": "2026-02-04T12:00:59.000Z",
          "weight": {
            "event_id": "101",
            "weight_kg": "420.00",
            "method": "scale",
            "shrink_pct": "0.50"
          }
        }
      }
    ],
    "side_effects": [
      "Each publish also forwards message to Redis channel ws:events",
      "All connected WS clients receive broadcast"
    ]
  },
  "data_model": {
    "enums": {
      "Role": [
        "admin",
        "manager",
        "viewer"
      ]
    },
    "models": {
      "User": {
        "fields": {
          "id": {
            "type": "BigInt",
            "id": true,
            "default": "autoincrement"
          },
          "email": {
            "type": "String",
            "unique": true
          },
          "password": {
            "type": "String"
          },
          "role": {
            "type": "Role"
          },
          "created_at": {
            "type": "DateTime",
            "default": "now"
          },
          "updated_at": {
            "type": "DateTime",
            "default": "now"
          }
        },
        "relations": {
          "tokens": {
            "model": "RefreshToken",
            "type": "one-to-many",
            "field": "user_id"
          }
        }
      },
      "RefreshToken": {
        "fields": {
          "id": {
            "type": "BigInt",
            "id": true,
            "default": "autoincrement"
          },
          "token": {
            "type": "String",
            "unique": true
          },
          "user_id": {
            "type": "BigInt"
          },
          "expires_at": {
            "type": "DateTime"
          },
          "revoked": {
            "type": "Boolean",
            "default": false
          },
          "created_at": {
            "type": "DateTime",
            "default": "now"
          }
        },
        "relations": {
          "user": {
            "model": "User",
            "type": "many-to-one",
            "field": "user_id",
            "onDelete": "Cascade"
          }
        }
      },
      "Animal": {
        "fields": {
          "uid": {
            "type": "String",
            "id": true
          },
          "eid": {
            "type": "String",
            "optional": true
          },
          "vid": {
            "type": "String",
            "optional": true
          },
          "registration_at": {
            "type": "DateTime",
            "optional": true
          },
          "alert": {
            "type": "Boolean",
            "default": false
          },
          "race": {
            "type": "String",
            "optional": true
          },
          "sex": {
            "type": "String",
            "optional": true
          },
          "color": {
            "type": "String",
            "optional": true
          },
          "mother_name": {
            "type": "String",
            "optional": true
          },
          "father_name": {
            "type": "String",
            "optional": true
          },
          "brand_mark": {
            "type": "String",
            "optional": true
          },
          "birth_year": {
            "type": "Int",
            "optional": true
          },
          "birth_month": {
            "type": "Int",
            "optional": true
          },
          "birth_place": {
            "type": "String",
            "optional": true
          },
          "diagnostic": {
            "type": "String",
            "optional": true
          },
          "warning": {
            "type": "String",
            "optional": true
          },
          "notes": {
            "type": "String",
            "optional": true
          },
          "created_at": {
            "type": "DateTime",
            "default": "now"
          },
          "updated_at": {
            "type": "DateTime",
            "default": "now"
          },
          "version": {
            "type": "Int",
            "default": 1
          }
        },
        "relations": {
          "events": {
            "model": "AnimalEvent",
            "type": "one-to-many",
            "field": "uid"
          },
          "costs": {
            "model": "CostEvent",
            "type": "one-to-many",
            "field": "uid"
          }
        }
      },
      "Location": {
        "fields": {
          "id": {
            "type": "BigInt",
            "id": true,
            "default": "autoincrement"
          },
          "code": {
            "type": "String",
            "unique": true
          },
          "name": {
            "type": "String",
            "optional": true
          },
          "type": {
            "type": "String",
            "optional": true
          },
          "meta": {
            "type": "Json",
            "optional": true
          },
          "created_at": {
            "type": "DateTime",
            "default": "now"
          },
          "updated_at": {
            "type": "DateTime",
            "default": "now"
          }
        },
        "relations": {
          "eventsFrom": {
            "model": "AnimalEvent",
            "type": "one-to-many",
            "field": "location_from_id"
          },
          "eventsTo": {
            "model": "AnimalEvent",
            "type": "one-to-many",
            "field": "location_to_id"
          },
          "costs": {
            "model": "CostEvent",
            "type": "one-to-many",
            "field": "location_id"
          }
        }
      },
      "HerdGroup": {
        "fields": {
          "id": {
            "type": "BigInt",
            "id": true,
            "default": "autoincrement"
          },
          "code": {
            "type": "String",
            "unique": true
          },
          "name": {
            "type": "String",
            "optional": true
          },
          "meta": {
            "type": "Json",
            "optional": true
          },
          "created_at": {
            "type": "DateTime",
            "default": "now"
          },
          "updated_at": {
            "type": "DateTime",
            "default": "now"
          }
        },
        "relations": {
          "events": {
            "model": "AnimalEvent",
            "type": "one-to-many",
            "field": "group_id"
          },
          "costs": {
            "model": "CostEvent",
            "type": "one-to-many",
            "field": "group_id"
          }
        }
      },
      "Party": {
        "fields": {
          "id": {
            "type": "BigInt",
            "id": true,
            "default": "autoincrement"
          },
          "code": {
            "type": "String",
            "unique": true
          },
          "name": {
            "type": "String",
            "optional": true
          },
          "type": {
            "type": "String",
            "optional": true
          },
          "meta": {
            "type": "Json",
            "optional": true
          },
          "created_at": {
            "type": "DateTime",
            "default": "now"
          },
          "updated_at": {
            "type": "DateTime",
            "default": "now"
          }
        },
        "relations": {
          "events": {
            "model": "AnimalEvent",
            "type": "one-to-many",
            "field": "party_id"
          },
          "costs": {
            "model": "CostEvent",
            "type": "one-to-many",
            "field": "party_id"
          },
          "transport_movements": {
            "model": "MovementEvent",
            "type": "one-to-many",
            "field": "transport_party_id"
          }
        }
      },
      "Product": {
        "fields": {
          "id": {
            "type": "BigInt",
            "id": true,
            "default": "autoincrement"
          },
          "code": {
            "type": "String",
            "unique": true
          },
          "name": {
            "type": "String",
            "optional": true
          },
          "category": {
            "type": "String",
            "optional": true
          },
          "unit": {
            "type": "String",
            "optional": true
          },
          "meta": {
            "type": "Json",
            "optional": true
          },
          "created_at": {
            "type": "DateTime",
            "default": "now"
          },
          "updated_at": {
            "type": "DateTime",
            "default": "now"
          }
        },
        "relations": {
          "events": {
            "model": "AnimalEvent",
            "type": "one-to-many",
            "field": "product_id"
          },
          "costs": {
            "model": "CostEvent",
            "type": "one-to-many",
            "field": "product_id"
          }
        }
      },
      "AnimalEvent": {
        "fields": {
          "event_id": {
            "type": "BigInt",
            "id": true,
            "default": "autoincrement"
          },
          "uid": {
            "type": "String"
          },
          "event_at": {
            "type": "DateTime"
          },
          "event_type": {
            "type": "String"
          },
          "event_subtype": {
            "type": "String",
            "optional": true
          },
          "source_ref": {
            "type": "String",
            "optional": true
          },
          "batch_id": {
            "type": "String",
            "optional": true
          },
          "confidence": {
            "type": "Decimal(5,2)",
            "optional": true
          },
          "notes": {
            "type": "String",
            "optional": true
          },
          "location_from_id": {
            "type": "BigInt",
            "optional": true
          },
          "location_to_id": {
            "type": "BigInt",
            "optional": true
          },
          "group_id": {
            "type": "BigInt",
            "optional": true
          },
          "party_id": {
            "type": "BigInt",
            "optional": true
          },
          "product_id": {
            "type": "BigInt",
            "optional": true
          },
          "payload": {
            "type": "Json",
            "optional": true
          },
          "created_at": {
            "type": "DateTime",
            "default": "now"
          }
        },
        "relations": {
          "animal": {
            "model": "Animal",
            "type": "many-to-one",
            "field": "uid",
            "onDelete": "Cascade"
          },
          "location_from": {
            "model": "Location",
            "type": "many-to-one",
            "field": "location_from_id"
          },
          "location_to": {
            "model": "Location",
            "type": "many-to-one",
            "field": "location_to_id"
          },
          "group": {
            "model": "HerdGroup",
            "type": "many-to-one",
            "field": "group_id"
          },
          "party": {
            "model": "Party",
            "type": "many-to-one",
            "field": "party_id"
          },
          "product": {
            "model": "Product",
            "type": "many-to-one",
            "field": "product_id"
          },
          "weight": {
            "model": "WeightEvent",
            "type": "one-to-one",
            "field": "event_id"
          },
          "movement": {
            "model": "MovementEvent",
            "type": "one-to-one",
            "field": "event_id"
          },
          "repro": {
            "model": "ReproEvent",
            "type": "one-to-one",
            "field": "event_id"
          },
          "health": {
            "model": "HealthEvent",
            "type": "one-to-one",
            "field": "event_id"
          },
          "nutrition": {
            "model": "NutritionEvent",
            "type": "one-to-one",
            "field": "event_id"
          },
          "costs": {
            "model": "CostEvent",
            "type": "one-to-many",
            "field": "event_id"
          }
        },
        "indexes": [
          "index(uid, event_at desc)",
          "index(event_type, event_at desc)",
          "index(batch_id)",
          "index(location_from_id)",
          "index(location_to_id)"
        ],
        "unique": [
          "unique(uid, event_at, event_type, event_subtype, source_ref) as uq_event_dedup"
        ],
        "table": "animal_event"
      },
      "WeightEvent": {
        "fields": {
          "event_id": {
            "type": "BigInt",
            "id": true
          },
          "weight_kg": {
            "type": "Decimal(10,2)",
            "optional": true
          },
          "method": {
            "type": "String",
            "optional": true
          },
          "shrink_pct": {
            "type": "Decimal(5,2)",
            "optional": true
          }
        },
        "relations": {
          "event": {
            "model": "AnimalEvent",
            "type": "one-to-one",
            "field": "event_id",
            "onDelete": "Cascade"
          }
        },
        "table": "weight_event"
      },
      "MovementEvent": {
        "fields": {
          "event_id": {
            "type": "BigInt",
            "id": true
          },
          "reason": {
            "type": "String",
            "optional": true
          },
          "distance_km": {
            "type": "Decimal(10,2)",
            "optional": true
          },
          "transport_party_id": {
            "type": "BigInt",
            "optional": true
          }
        },
        "relations": {
          "event": {
            "model": "AnimalEvent",
            "type": "one-to-one",
            "field": "event_id",
            "onDelete": "Cascade"
          },
          "transport_party": {
            "model": "Party",
            "type": "many-to-one",
            "field": "transport_party_id"
          }
        },
        "table": "movement_event"
      },
      "ReproEvent": {
        "fields": {
          "event_id": {
            "type": "BigInt",
            "id": true
          },
          "repro_action": {
            "type": "String",
            "optional": true
          },
          "sire_uid": {
            "type": "String",
            "optional": true
          },
          "dam_uid": {
            "type": "String",
            "optional": true
          },
          "result": {
            "type": "String",
            "optional": true
          },
          "calf_uid": {
            "type": "String",
            "optional": true
          },
          "gestation_days": {
            "type": "Int",
            "optional": true
          }
        },
        "relations": {
          "event": {
            "model": "AnimalEvent",
            "type": "one-to-one",
            "field": "event_id",
            "onDelete": "Cascade"
          }
        },
        "table": "repro_event"
      },
      "HealthEvent": {
        "fields": {
          "event_id": {
            "type": "BigInt",
            "id": true
          },
          "action": {
            "type": "String",
            "optional": true
          },
          "diagnosis": {
            "type": "String",
            "optional": true
          },
          "dose": {
            "type": "Decimal(10,2)",
            "optional": true
          },
          "dose_unit": {
            "type": "String",
            "optional": true
          },
          "withdrawal_days": {
            "type": "Int",
            "optional": true
          }
        },
        "relations": {
          "event": {
            "model": "AnimalEvent",
            "type": "one-to-one",
            "field": "event_id",
            "onDelete": "Cascade"
          }
        },
        "table": "health_event"
      },
      "NutritionEvent": {
        "fields": {
          "event_id": {
            "type": "BigInt",
            "id": true
          },
          "ration_code": {
            "type": "String",
            "optional": true
          },
          "intake_kg_day": {
            "type": "Decimal(10,2)",
            "optional": true
          },
          "supplement_code": {
            "type": "String",
            "optional": true
          },
          "reason": {
            "type": "String",
            "optional": true
          }
        },
        "relations": {
          "event": {
            "model": "AnimalEvent",
            "type": "one-to-one",
            "field": "event_id",
            "onDelete": "Cascade"
          }
        },
        "table": "nutrition_event"
      },
      "CostEvent": {
        "fields": {
          "cost_id": {
            "type": "BigInt",
            "id": true,
            "default": "autoincrement"
          },
          "cost_at": {
            "type": "DateTime"
          },
          "scope": {
            "type": "String"
          },
          "uid": {
            "type": "String",
            "optional": true
          },
          "group_id": {
            "type": "BigInt",
            "optional": true
          },
          "location_id": {
            "type": "BigInt",
            "optional": true
          },
          "category": {
            "type": "String"
          },
          "product_id": {
            "type": "BigInt",
            "optional": true
          },
          "party_id": {
            "type": "BigInt",
            "optional": true
          },
          "amount": {
            "type": "Decimal(14,2)"
          },
          "currency": {
            "type": "String",
            "default": "BOB"
          },
          "quantity": {
            "type": "Decimal(65,30)",
            "optional": true
          },
          "unit": {
            "type": "String",
            "optional": true
          },
          "source_ref": {
            "type": "String",
            "optional": true
          },
          "batch_id": {
            "type": "String",
            "optional": true
          },
          "notes": {
            "type": "String",
            "optional": true
          },
          "created_at": {
            "type": "DateTime",
            "default": "now"
          },
          "event_id": {
            "type": "BigInt",
            "optional": true
          }
        },
        "relations": {
          "animal": {
            "model": "Animal",
            "type": "many-to-one",
            "field": "uid"
          },
          "group": {
            "model": "HerdGroup",
            "type": "many-to-one",
            "field": "group_id"
          },
          "location": {
            "model": "Location",
            "type": "many-to-one",
            "field": "location_id"
          },
          "product": {
            "model": "Product",
            "type": "many-to-one",
            "field": "product_id"
          },
          "party": {
            "model": "Party",
            "type": "many-to-one",
            "field": "party_id"
          },
          "event": {
            "model": "AnimalEvent",
            "type": "many-to-one",
            "field": "event_id"
          }
        },
        "indexes": [
          "index(scope, cost_at desc)",
          "index(uid, cost_at desc)",
          "index(category, cost_at desc)",
          "index(batch_id)"
        ],
        "table": "cost_event"
      },
      "DerivedMetric": {
        "fields": {
          "id": {
            "type": "BigInt",
            "id": true,
            "default": "autoincrement"
          },
          "kind": {
            "type": "String"
          },
          "uid": {
            "type": "String",
            "optional": true
          },
          "data": {
            "type": "Json"
          },
          "computed_at": {
            "type": "DateTime",
            "default": "now"
          }
        },
        "indexes": [
          "index(kind)",
          "index(uid)"
        ],
        "table": "derived_metrics"
      }
    }
  },
  "dedupe_idempotency": {
    "event_unique_index": {
      "name": "uq_event_dedup",
      "table": "animal_event",
      "columns": [
        "uid",
        "event_at",
        "event_type",
        "event_subtype",
        "source_ref"
      ],
      "normalization": "event_subtype and source_ref use COALESCE(value, '') in dedupe query",
      "behavior_on_conflict": "Create returns existing event and HTTP 200"
    },
    "idempotency_key_header": {
      "header": "idempotency-key",
      "behavior": [
        "Value stored exactly as provided (no trimming/normalization)",
        "Overrides source_ref for /events when idempotency-key header is present",
        "Bulk: when idempotency-key header is present, it overrides source_ref for every event in /events/bulk"
      ]
    },
    "optimistic_concurrency": {
      "animals_patch": {
        "header": "if-match-version",
        "required": true,
        "on_mismatch": {
          "status": 409,
          "body": {
            "message": "Version mismatch",
            "details": {
              "currentVersion": "number"
            }
          }
        }
      }
    },
    "costs": {
      "dedupe": "none",
      "note": "Callers should provide unique source_ref if needed"
    }
  },
  "dimensions": {
    "tables": {
      "location": {
        "model": "Location",
        "code_field": "code",
        "unique": true,
        "fields": [
          "id",
          "code",
          "name",
          "type",
          "meta",
          "created_at",
          "updated_at"
        ]
      },
      "herdGroup": {
        "model": "HerdGroup",
        "code_field": "code",
        "unique": true,
        "fields": [
          "id",
          "code",
          "name",
          "meta",
          "created_at",
          "updated_at"
        ]
      },
      "party": {
        "model": "Party",
        "code_field": "code",
        "unique": true,
        "fields": [
          "id",
          "code",
          "name",
          "type",
          "meta",
          "created_at",
          "updated_at"
        ]
      },
      "product": {
        "model": "Product",
        "code_field": "code",
        "unique": true,
        "fields": [
          "id",
          "code",
          "name",
          "category",
          "unit",
          "meta",
          "created_at",
          "updated_at"
        ]
      }
    },
    "auto_create": {
      "enabled": true,
      "when": [
        "/events create",
        "/events/bulk",
        "/costs create",
        "/costs/bulk",
        "import scripts"
      ],
      "behavior": [
        "Codes are matched exactly as provided (case and whitespace preserved)",
        "If missing, create a new row with code and other fields null",
        "Movement events require location_from_code and location_to_code, but missing locations are auto-created"
      ]
    },
    "create_schema_fields": [
      "code",
      "name",
      "type",
      "category",
      "unit",
      "meta"
    ],
    "field_support_by_table": {
      "location": [
        "code",
        "name",
        "type",
        "meta"
      ],
      "herdGroup": [
        "code",
        "name",
        "meta"
      ],
      "party": [
        "code",
        "name",
        "type",
        "meta"
      ],
      "product": [
        "code",
        "name",
        "category",
        "unit",
        "meta"
      ]
    }
  },
  "analytics": {
    "derived_metrics": {
      "animal_metrics": {
        "kind": "animal_metrics",
        "fields": [
          "adg",
          "last_weight",
          "last_weight_at",
          "prev_weight",
          "prev_weight_at",
          "last_location_id"
        ]
      },
      "summary": {
        "kind": "summary",
        "fields": [
          "avg_adg",
          "monthly_kilos",
          "computed_at"
        ],
        "monthly_kilos_item": {
          "month": "date",
          "kilos": "number"
        }
      }
    },
    "schedule": {
      "cron": "*/10 * * * *",
      "runs_on_startup": true,
      "disabled_env": "DISABLE_ANALYTICS_JOBS"
    },
    "cache": {
      "summary": {
        "redis_key": "metrics:summary",
        "ttl_sec": 300
      }
    }
  },
  "csv_import": {
    "animals_seed": {
      "script": "apps/api/src/scripts/seed.ts",
      "csv_path_default": "data/ANIMAL_REG - data.csv",
      "required_headers": [
        "uid"
      ],
      "optional_headers": [
        "eid",
        "vid",
        "sex",
        "race",
        "brand_mark",
        "mother_name",
        "father_name",
        "birth_year",
        "birth_month",
        "color",
        "registration_at",
        "alert",
        "birth_place",
        "diagnostic",
        "warning",
        "notes"
      ],
      "notes": [
        "Headers normalized to lowercase snake_case",
        "uid required; eid/vid uniqueness checked; behavior depends on SEED_STRICT",
        "sex normalized to M/F; alert parsed as boolean",
        "Upserts animals by uid"
      ]
    },
    "events_import": {
      "script": "apps/api/src/scripts/import-events.ts",
      "required_headers": [
        "uid",
        "event_at",
        "event_type"
      ],
      "optional_headers": [
        "event_subtype",
        "source_ref",
        "batch_id",
        "notes",
        "confidence",
        "location_from_code",
        "location_to_code",
        "group_code",
        "party_code",
        "product_code",
        "weight_kg",
        "method",
        "shrink_pct",
        "reason",
        "distance_km",
        "transport_party_code",
        "repro_action",
        "sire_uid",
        "dam_uid",
        "result",
        "calf_uid",
        "gestation_days",
        "action",
        "diagnosis",
        "dose",
        "dose_unit",
        "withdrawal_days",
        "ration_code",
        "intake_kg_day",
        "supplement_code"
      ],
      "event_type_enum": [
        "weight",
        "movement",
        "repro",
        "health",
        "nutrition",
        "inventory",
        "management",
        "diagnostic",
        "environment"
      ],
      "dedupe": "Uses event unique index; duplicates return existing event (deduped count tracked)",
      "cli": {
        "required": [
          "--file=path.csv"
        ],
        "optional": [
          "--dry-run",
          "--limit=N",
          "--max-errors=N",
          "--report=path.json",
          "--allow-errors"
        ]
      }
    },
    "costs_import": {
      "script": "apps/api/src/scripts/import-costs.ts",
      "required_headers": [
        "cost_at",
        "scope",
        "category",
        "amount"
      ],
      "optional_headers": [
        "uid",
        "group_code",
        "location_code",
        "product_code",
        "party_code",
        "currency",
        "quantity",
        "unit",
        "source_ref",
        "batch_id",
        "notes"
      ],
      "cli": {
        "required": [
          "--file=path.csv"
        ],
        "optional": [
          "--dry-run",
          "--limit=N",
          "--max-errors=N",
          "--batch-size=N",
          "--report=path.json",
          "--allow-errors"
        ]
      }
    }
  },
  "examples": {
    "auth_login": {
      "request": {
        "email": "admin@example.com",
        "password": "admin1234"
      },
      "response": {
        "accessToken": "<jwt-access>",
        "refreshToken": "<jwt-refresh>",
        "expires_at": "2026-02-04T12:15:00.000Z",
        "user": {
          "id": 1,
          "email": "admin@example.com",
          "role": "admin"
        }
      }
    },
    "animal_create": {
      "request": {
        "uid": "A-001",
        "eid": "E-001",
        "race": "BRAHMAN",
        "sex": "F",
        "birth_year": 2023,
        "birth_month": 4,
        "brand_mark": "BR-12"
      },
      "response": {
        "uid": "A-001",
        "eid": "E-001",
        "race": "BRAHMAN",
        "sex": "F",
        "birth_year": 2023,
        "birth_month": 4,
        "brand_mark": "BR-12",
        "alert": false,
        "version": 1,
        "created_at": "2026-02-04T12:00:00.000Z",
        "updated_at": "2026-02-04T12:00:00.000Z"
      }
    },
    "animal_patch": {
      "headers": {
        "if-match-version": "1"
      },
      "request": {
        "alert": true,
        "notes": "Pregnant"
      },
      "response": {
        "uid": "A-001",
        "alert": true,
        "notes": "Pregnant",
        "version": 2
      }
    },
    "event_create_weight": {
      "headers": {
        "idempotency-key": "evt-0001"
      },
      "request": {
        "uid": "A-001",
        "event_at": "2026-02-04T11:59:00.000Z",
        "event_type": "weight",
        "weight_kg": 420,
        "method": "scale",
        "shrink_pct": 0.5
      },
      "response": {
        "event_id": "101",
        "uid": "A-001",
        "event_at": "2026-02-04T11:59:00.000Z",
        "event_type": "weight",
        "source_ref": "evt-0001",
        "payload": {
          "weight_kg": 420,
          "method": "scale",
          "shrink_pct": 0.5
        },
        "weight": {
          "event_id": "101",
          "weight_kg": "420.00",
          "method": "scale",
          "shrink_pct": "0.50"
        }
      }
    },
    "cost_create": {
      "request": {
        "cost_at": "2026-02-04T00:00:00.000Z",
        "scope": "animal",
        "category": "feed",
        "amount": 123.45,
        "uid": "A-001",
        "location_code": "LOT-01",
        "source_ref": "feed-dec05"
      },
      "response": {
        "cost_id": "501",
        "cost_at": "2026-02-04T00:00:00.000Z",
        "scope": "animal",
        "category": "feed",
        "amount": "123.45",
        "currency": "BOB",
        "uid": "A-001",
        "location_id": "10",
        "source_ref": "feed-dec05"
      }
    },
    "dimension_create": {
      "request": {
        "code": "LOT-01",
        "name": "Lot 1",
        "type": "paddock"
      },
      "response": {
        "id": "10",
        "code": "LOT-01",
        "name": "Lot 1",
        "type": "paddock"
      }
    },
    "analytics_summary": {
      "response": {
        "avg_adg": 0.75,
        "monthly_kilos": [
          {
            "month": "2026-02-01T00:00:00.000Z",
            "kilos": 1200
          }
        ],
        "computed_at": "2026-02-04T12:00:00.000Z"
      }
    },
    "ws_message": {
      "topic": "dimension.updated",
      "ts": "2026-02-04T12:05:00.000Z",
      "requestId": "req-200",
      "data": {
        "table": "location",
        "code": "LOT-01"
      }
    },
    "csv_rows": {
      "event_row": "uid,event_at,event_type,location_from_code,location_to_code,weight_kg,method,source_ref",
      "event_row_example": "A-001,2024-12-01T10:00:00Z,weight,,,420,scale,batch-001-row-1",
      "cost_row": "cost_at,scope,category,amount,uid,location_code,source_ref",
      "cost_row_example": "2024-12-05T00:00:00Z,animal,feed,123.45,A-001,LOT-01,feed-dec05"
    }
  }
}
